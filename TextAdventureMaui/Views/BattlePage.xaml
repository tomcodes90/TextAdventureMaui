<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:TextAdventureMaui.Views.Controls"
             xmlns:vm="clr-namespace:TextAdventureMaui.ViewModels"
             xmlns:models="clr-namespace:TextAdventureMaui.Models.Entities"
             x:Class="TextAdventureMaui.Views.BattlePage"
             x:DataType="vm:BattleViewModel"
             Title="Battle"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

    <Grid RowDefinitions="*,*,*,*" ColumnDefinitions="*,*">

        <!-- Enemy (Top Left) -->
        <controls:BattleCharacterView Grid.Row="0" Grid.Column="0"
                                      Image="maxime.png"
                                      CharacterName="{Binding Enemy.Name}"
                                      HpPercent="{Binding EnemyHpPercent}"
                                      BorderBrush="{StaticResource ActionPrimary}"
                                      BarBrush="{StaticResource ActionPrimary}"/>

        <!-- Player (Bottom Right) -->
        <controls:BattleCharacterView Grid.Row="3" Grid.Column="1"
                                      Image="ashita.png"
                                      CharacterName="{Binding Player.Name}"
                                      HpPercent="{Binding PlayerHpPercent}"
                                      BorderBrush="{StaticResource ActionPrimary}"
                                      BarBrush="{StaticResource ActionPrimary}"/>

        <!-- Log + Moves (Bottom Left) -->
        <Border Grid.Row="3" Grid.Column="0"
                Stroke="{StaticResource Gray500Brush}" StrokeShape="RoundRectangle 0"
                BackgroundColor="{StaticResource Gray900}" Padding="10">
            <Grid RowDefinitions="*" ColumnDefinitions="*">
                <Label Text="{Binding BattleLog}" FontSize="14"
                       HorizontalOptions="Center" VerticalOptions="Start"
                       TextColor="{StaticResource TextPrimary}"
                       LineBreakMode="WordWrap"/>

                <controls:AbilityListView Abilities="{Binding Player.Abilities}"
                                          Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"/>

            </Grid>
        </Border>

        <!-- Central battle sequence panel (EnemySequence / CurrentInput) -->
        <controls:BattleSequencePanel Grid.Row="1"
                                      Grid.RowSpan="2"
                                      Grid.ColumnSpan="2"
                                      EnemySequence="{Binding EnemySequence}"
                                      CurrentInput="{Binding CurrentInput}"
                                      IsEnemyTurn="{Binding IsEnemyTurn}" />
        <Entry x:Name="KeyboardCapture"
               Grid.Row="1"
               IsVisible="False"
               TextChanged="KeyboardCapture_TextChanged" />

        <!-- Combat Pad -->
        <controls:CombatPad Grid.Row="2"
                            Grid.ColumnSpan="2"
                            BindingContext="{Binding}" />

        <!-- Confirm / Clear -->
        <HorizontalStackLayout Grid.Row="2" Grid.ColumnSpan="2"
                               HorizontalOptions="Center"
                               VerticalOptions="End"
                               Spacing="10"
                               Margin="0,10">
            <Button Text="Confirm" 
                    Command="{Binding ConfirmInputCommand}" 
                    IsEnabled="{Binding IsEnemyTurn, Converter={StaticResource InverseBoolConverter}}" />
            <Button Text="Clear" 
                    Command="{Binding ClearInputCommand}" 
                    IsEnabled="{Binding IsEnemyTurn, Converter={StaticResource InverseBoolConverter}}" />
        </HorizontalStackLayout>
    </Grid>
</ContentPage>
